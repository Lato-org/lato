<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lato AI Agent</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .chat-container {
      height: calc(100vh - 200px);
    }
  </style>
</head>
<body class="bg-[#1f262c] min-h-screen flex items-center">
  <div id="root" class="w-full"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect } = React;

    function MessageContent({ content }) {
      const [isCodeVisible, setIsCodeVisible] = useState(false);
      const [copySuccess, setCopySuccess] = useState(false);

      const handleToggleCode = () => {
      setIsCodeVisible(!isCodeVisible);
      };

      const handleCopyCode = (code) => {
      navigator.clipboard.writeText(code).then(() => {
        setCopySuccess(true);
        setTimeout(() => setCopySuccess(false), 2000);
      });
      };

      const regex = /```(.*?)```/gs;
      const parts = content.split(regex);

      return (
      <div>
        {parts.map((part, index) => {
        if (index % 3 === 0) {
          return <span key={index}>{part}</span>;
        } else if (index % 3 === 1) {
          return (
          <div key={index} className="bg-gray-200 p-2 rounded mt-2 mb-2">
            <div className="flex justify-between items-center mb-2 border-b pb-2">
            <button onClick={handleToggleCode} className="text-blue-500 hover:text-blue-700">
              {isCodeVisible ? "Nascondi codice" : "Mostra codice"}
            </button>
            {isCodeVisible && (
              <button 
              onClick={() => handleCopyCode(part)}
              className="text-gray-600 hover:text-gray-800 text-sm"
              >
              {copySuccess ? "Copiato!" : "Copia codice"}
              </button>
            )}
            </div>
            {isCodeVisible && (
            <pre className="overflow-x-auto bg-gray-100 p-2 rounded">
              {part}
            </pre>
            )}
          </div>
          );
        }
        })}
      </div>
      );
    }

    function App() {
      const [apiKey, setApiKey] = useState("");
      const [context, setContext] = useState("");
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [loading, setLoading] = useState(false);
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [error, setError] = useState("");
      const chatContainerRef = useRef(null);
      
      useEffect(() => {
        const storedApiKey = localStorage.getItem("apiKey");
        if (storedApiKey) {
          setApiKey(storedApiKey);
          setIsAuthenticated(true);
        }
      }, []);

      useEffect(() => {
        fetch("./llm.txt")
          .then(response => response.text())
          .then(data => setContext(data))
          .catch(error => console.error("Errore nel caricamento del contesto:", error));
      }, []);

      useEffect(() => {
        if (isAuthenticated) {
          localStorage.setItem("apiKey", apiKey);
        }
      }, [isAuthenticated, apiKey]);

      useEffect(() => {
        if (chatContainerRef.current) {
          chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
      }, [messages]);

      const handleSubmitApiKey = () => {
        if (!apiKey.trim()) {
          setError("Per favore, inserisci una API key valida");
          return;
        }
        
        setIsAuthenticated(true);
        setMessages([
          { role: "assistant", content: "Ciao! Come posso aiutarti?" }
        ]);
      };

      const handleSendMessage = async (e) => {
        e.preventDefault();
        
        if (!input.trim()) return;
        
        const systemMessage = { role: "system", content: `
        Sei un assistente che aiuta gli utenti a sviluppare con la gemma Lato di Ruby on Rails.
        Utilizza la documentazione fornita per dare supporto all'utente.
        Fornisci esempi di codice utilizzando le funzioni e i codici esempio messi a disposizione dalla documentazione.
        Non fornire informazioni non correlate alla gemma Lato.
        ${context}
        ` };
        const userMessage = { role: "user", content: input };
        setMessages(prevMessages => [...prevMessages, userMessage]);
        setInput("");
        setLoading(true);
        
        try {
          const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: [systemMessage, ...messages, userMessage],
              temperature: 0.7
            })
          });
          
          if (!response.ok) {
            throw new Error(`Errore nella richiesta: ${response.status}`);
          }
          
          const data = await response.json();
          const assistantMessage = { 
            role: "assistant", 
            content: data.choices[0].message.content 
          };
          
          setMessages(prevMessages => [...prevMessages, assistantMessage]);
        } catch (error) {
          console.error("Errore:", error);
          setError(`Si Ã¨ verificato un errore: ${error.message}`);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="container mx-auto p-4 max-w-4xl">
          {!isAuthenticated ? (
            <div className="bg-white p-8 rounded-lg shadow-md">
              <h1 className="text-2xl font-bold text-center mb-6">Lato AI Agent</h1>
              <div className="mb-4">
                <label className="block text-gray-700 mb-2" htmlFor="apiKey">
                  Inserisci la tua API Key di OpenAI
                </label>
                <input
                  id="apiKey"
                  type="password"
                  className="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="sk-..."
                />
                {error && <p className="text-red-500 mt-2">{error}</p>}
              </div>
              <button
                onClick={handleSubmitApiKey}
                className="w-full bg-[#293b5a] text-white py-2 px-4 rounded transition-colors"
              >
                Inizia a chattare
              </button>
              <p className="text-sm text-gray-500 mt-4 text-center">
                La tua API key viene utilizzata solo localmente e non viene salvata.
              </p>
            </div>
          ) : (
            <div className="bg-white rounded-lg shadow-md overflow-hidden">
              <div className="bg-[#293b5a] p-4">
                <h1 className="text-xl font-bold text-white">Lato AI Agent</h1>
              </div>
              
              <div 
                ref={chatContainerRef}
                className="chat-container p-4 overflow-y-auto"
              >
                {messages.map((msg, index) => (
                  <div
                    key={index}
                    className={`mb-4 ${
                      msg.role === "user" ? "text-right" : "text-left"
                    }`}
                  >
                    <div
                      className={`inline-block p-3 rounded-lg max-w-xs sm:max-w-md ${
                        msg.role === "user"
                          ? "bg-blue-100 text-blue-800"
                          : "bg-gray-100 text-gray-800"
                      }`}
                    >
                      <MessageContent content={msg.content} />
                    </div>
                  </div>
                ))}
                {loading && (
                  <div className="text-left mb-4">
                    <div className="inline-block p-3 rounded-lg bg-gray-100">
                      <div className="flex space-x-2">
                        <div className="h-2 w-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div className="h-2 w-2 bg-gray-400 rounded-full animate-bounce delay-100"></div>
                        <div className="h-2 w-2 bg-gray-400 rounded-full animate-bounce delay-200"></div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              <form onSubmit={handleSendMessage} className="p-4 bg-[#7b96c4]">
                <div className="flex">
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    className="flex-1 p-2 border border-gray-300 bg-white rounded-l focus:outline-none focus:ring-2 focus:ring-[#293b5a]"
                    placeholder="Scrivi un messaggio..."
                  />
                  <button
                    type="submit"
                    disabled={loading}
                    className="bg-[#293b5a] text-white px-4 py-2 rounded-r transition-colors"
                  >
                    Invia
                  </button>
                </div>
                {error && <p className="text-red-500 mt-2">{error}</p>}
              </form>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>